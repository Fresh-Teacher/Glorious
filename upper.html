<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Welcome To Glorious Schools, #1 Academic Giant in Ugandan Educational Sector.">
    <meta name="keyword"
        content="Glorious TV, educational videos, Schemes Of Work, Lesson Plans, Lesson Notes, Topical Questions, Luganda Translated Movies, Past Papers">
    <meta name="author" content="Fresh Teacher">
    <link rel="icon" type="image/png" sizes="16x16" href="schoologo-2-150x150.png">
    <link data-n-head="ssr" rel="manifest" href="/manifest.json" data-hid="manifest">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <meta property="og:site_name" content="Fresh Teacher's Library" />
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <meta property="og:image" content="https://gloriouschools.vercel.app/gallery.jpg" />
      <title>Glorious Examinations Board</title>
    <style>
        :root {
            --primary-color: #FF8C00;
            --secondary-color: #FFA500;
            --light-color: #FFE4B5;
            --dark-color: #D2691E;
            --white-color: #FFFFFF;
        }
        
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--light-color);
        }
        
        .container {
            width: 90%;
            max-width: 1200px;
            margin: auto;
            overflow: hidden;
            padding: 10px;
            text-align: center;
        }
        
        .card {
            background-color: var(--white-color);
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .logo {
            max-width: 150px;
            margin-bottom: 10px;
        }
        
        h1, h2 {
            color: var(--dark-color);
            margin: 10px 0;
        }
        
        .select-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            margin-bottom: 10px;
            width: 60%;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }
        
        select, button {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--secondary-color);
            border-radius: 5px;
            background-color: var(--white-color);
            color: var(--dark-color);
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        select:focus, button:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--secondary-color);
        }
        
        button {
            background-color: var(--primary-color);
            color: var(--white-color);
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        button:hover {
            background-color: var(--dark-color);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 12px; /* Adjusted font size */
        }
        
        th, td {
            border: 1px solid var(--secondary-color);
            padding: 6px; /* Adjusted padding */
            text-align: left;
        }
        
        th {
            background-color: var(--primary-color);
            color: var(--white-color);
        }
        
        input[type="text"] {
            width: 40px;
            padding: 4px;
            border: 1px solid var(--secondary-color);
            border-radius: 3px;
        }
        
        .subject-aggregate, .total-aggregates, .division {
            font-size: 12px;
        }
        
        .info-section {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .grade-info, .division-info {
            flex-basis: 48%;
            background-color: var(--light-color);
            border-radius: 5px;
            padding: 15px;
        }
        
        @media screen and (max-width: 768px) {
            table {
                font-size: 10px; /* Adjusted font size for smaller screens */
            }
        
            th, td {
                padding: 4px; /* Adjusted padding for smaller screens */
            }
        
            input[type="text"] {
                width: 30px;
                padding: 2px;
            }
        
            .subject-aggregate, .total-aggregates, .division {
                font-size: 10px;
            }
        }
        
        @media screen and (max-width: 480px) {
            table {
                font-size: 8px; /* Adjusted font size for smallest screens */
            }
        
            th, td {
                padding: 2px; /* Adjusted padding for smallest screens */
            }
        
            input[type="text"] {
                width: 25px;
                padding: 1px;
            }
        
            .subject-aggregate, .total-aggregates, .division {
                font-size: 9px;
            }
        }
        
        .grade-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .grade-table th, .grade-table td {
            border: 1px solid var(--secondary-color);
            padding: 6px; /* Adjusted padding */
            text-align: left;
        }
        
        .grade-table th {
            background-color: var(--primary-color);
            color: var(--white-color);
        }
        
        .grade-table tr:nth-child(even) {
            background-color: var(--light-color);
        }
        
        .info-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .info-table th, .info-table td {
            border: 1px solid var(--secondary-color);
            padding: 6px; /* Adjusted padding */
            text-align: left;
        }
        
        .info-table th {
            background-color: var(--primary-color);
            color: var(--white-color);
        }
        
        .invalid-input {
            background-color: #ffdddd;
            border: 1px solid #ff0000;
            color: #ff0000;
        }
        

        
        #fileInput {
            display: none;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 1000;
        }
        
        .notification.success {
            background-color: #4CAF50;
        }
        
        .notification.error {
            background-color: #f44336;
        }
        
        .notification.info {
            background-color: #2196F3;
        }
        
        .notification-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding-top: 20px;
            z-index: 1000;
        }
        
        .progress-bar {
            width: 100%;
            height: 5px;
            background-color: rgba(255, 255, 255, 0.3);
            position: absolute;
            bottom: 0;
            left: 0;
            border-radius: 0 0 5px 5px;
        }
        
        .progress {
            width: 0;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 0 0 5px 5px;
            transition: width 0.3s linear;
        }

        table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    font-size: 12px;
}

th, td {
    border: 1px solid var(--secondary-color);
    padding: 4px;
    text-align: left;
}

input[type="text"] {
    width: 35px;
    padding: 2px;
    border: 1px solid var(--secondary-color);
    border-radius: 3px;
}

@media screen and (max-width: 768px) {
    table {
        font-size: 10px;
    }

    th, td {
        padding: 2px;
    }

    input[type="text"] {
        width: 30px;
        padding: 1px;
    }
}

@media screen and (max-width: 480px) {
    table {
        font-size: 8px;
    }

    th, td {
        padding: 1px;
    }

    input[type="text"] {
        width: 25px;
        padding: 0;
    }
}
.minor-subject {
    background-color: #f0f0f0;
    color: #666;
}

input.minor-subject {
    background-color: #f8f8f8;
}
.analysis-section {
    margin-top: 20px;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
}

.analysis-section > div {
    flex-basis: calc(50% - 10px);
    margin-bottom: 20px;
}

.analysis-section table {
    width: 100%;
    border-collapse: collapse;
}

.analysis-section th, .analysis-section td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
}

.analysis-section th {
    background-color: #f2f2f2;
}


@media print {

    body {
        font-size: 14pt;
        font-family: 'Times New Roman', Georgia, serif;
        font-weight: bold;
        margin: 0; /* Remove body margin */
        padding: 0; /* Remove body padding */    }
    .container {
        width: 100%;
        margin: 0;
        padding: 0;
    }
        /* Ensure the table starts immediately after the title */
        #gradeTable {
        margin-top: 0.5cm;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        table-layout: auto;
        border: 2px solid black;
        margin-bottom: 20px;
    }
    th, td {
        border: 2px solid black;
        padding: 4px;
        font-size: 14pt;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        text-align: center; /* Center-align all cell content */
    }
    th {
        font-weight: bold;
        text-transform: capitalize;
        background-color: white;
        color: black;
    }
    input[type="text"] {
        border: none;
        background: none;
        font-family: inherit;
        font-size: 14pt;
        font-weight: bold;
        width: 100%;
        padding: 0;
        margin: 0;
        text-align: center; /* Center-align input text */
    }
    h1, h2, h3, p {
        margin: 5px 0;
        font-weight: bold;
        font-size: 14pt;
        color: black;
    }
    .pdf-title {
        text-align: center;
        font-size: 16pt;
        font-weight: bold;
        margin-top: 0; /* Remove top margin */
        padding-top: 0.5cm; /* Add a small padding at the top */
        line-height: 1.4;
        color: black;
    }
    .pdf-title h1, .pdf-title h2, .pdf-title h3 {
        margin: 5px 0 0 0;
        padding: 0;
        text-transform: capitalize;
        color: black;
    }
    .pdf-title h1 { font-size: 16pt; }
    .pdf-title h2, .pdf-title h3 { font-size: 14pt; }

    /* Make all table cells have the same font size and weight */
    table td, table th {
        font-family: "Times New Roman", serif;
        font-size: 14pt;
        font-weight: bold;
    }

    

    /* Keep the uppercase style for the first column */
    table td:first-child {
        text-transform: uppercase;
        text-align: left; /* Left-align names */
    }

    /* Specific styling for Division and Aggregate columns */
    table td:nth-last-child(-n+3),
    table th:nth-last-child(-n+3) {
        font-size: 14pt; /* Ensure size is consistent */
        font-weight: bold;
    }

  /* Hide specific buttons */
  #saveJsonBtn,
    #importJsonBtn,

    #generatePdfBtn{
        display: none !important;
    }

    /* Hide all input elements of type file */
    input[type="file"] {
        display: none !important;
    }


    /* Styles for analysis tables */
    .analysis-section table {
        margin-top: 20px;
    }
    .analysis-section h3 {
        page-break-inside: avoid;
        margin-top: 20px;
    }

    /* Ensure all table cells in all tables have thick borders */
    table, th, td {
        border: 2px solid black !important;
    }
}

  /* Hide the header and footer added by the browser */
  @page {
        margin: 0;
    }
    body {
        margin: 1cm;
    }
    /* Hide header */
    body::before {
        content: none !important;
    }
    /* Hide footer */
    body::after {
        content: none !important;
    }

     /* Hide any other elements that might appear in the print version */
     header, footer, .no-print {
        display: none !important;
    }
    /* Hide the original header */
    header, .header {
        display: none !important;
    }

    /* Style for the new title */
    .pdf-title {
        text-align: center;
        font-size: 16pt;
        font-weight: bold;
        margin-bottom: 20px;
        line-height: 1.4;
    }

    .pdf-title h1 {
        margin: 0;
        padding: 0;
    }

    .pdf-title h2 {
        margin: 5px 0 0 0;
        padding: 0;
        font-size: 14pt;
    }

    .pdf-title h3 {
        margin: 5px 0 0 0;
        padding: 0;
        font-size: 12pt;
    }
    #approvalTable {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

#approvalTable th, #approvalTable td {
    border: 1px solid var(--secondary-color);
    padding: 8px;
    text-align: left;
}

#approvalTable th {
    background-color: var(--primary-color);
    color: var(--white-color);
    width: 30%;
}

#approvalTable td {
    height: 30px; /* Provides space for handwritten entries */
}

@media print {
    #approvalTable {
        page-break-inside: avoid;
    }

    #approvalTable th, #approvalTable td {
        border: 2px solid black;
    }

    #approvalTable th {
        background-color: white;
        color: black;
    }
}

/* Navbar styles */
.navbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #ff8c00;
    padding: 0.5rem 1rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
}

.navbar .logo {
    display: flex;
    align-items: center;
}

.navbar .logo img {
    width: 40px;
    height: auto;
    margin-right: 10px;
}

.navbar .logo .title {
    color: white;
    font-size: 1.5rem;
    font-weight: bold;
}

.navbar ul {
    list-style: none;
    display: flex;
    margin: 0;
    padding: 0;
}

.navbar ul li {
    margin-left: 1rem;
}

.navbar ul li a {
    color: white;
    text-decoration: none;
    padding: 0.5rem 1rem;
    display: block;
    transition: background-color 0.3s ease;
    font-size: 1rem;
    border-radius: 5px;
}

.navbar ul li a:hover {
    background-color: #e06b00;
}

.navbar .toggle {
    display: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
}

.logout-button {
    padding: 0.5rem 1rem;
    background-color: #e06b00;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.logout-button:hover {
    background-color: #d65600;
}

/* Animated title */
@keyframes colorChange {
    0% { color: white; }
    50% { color: #FFE0B2; }
    100% { color: white; }
}

.animated-title {
    animation: colorChange 4s infinite;
    font-weight: bold;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
}

/* Footer styles */
/* Footer styles */
.footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: #ff8c00;
    color: white;
    text-align: center;
    padding: 0.5rem 0;
    font-size: 0.9rem;
    box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
    z-index: 1000;
}


.footer p {
    margin: 0;
}

/* Responsive styles */
@media (max-width: 768px) {
    .navbar {
        flex-direction: column;
        align-items: flex-start;
    }

    .navbar ul {
        flex-direction: column;
        width: 100%;
        display: none;
    }

    .navbar ul.show {
        display: flex;
    }

    .navbar ul li {
        margin: 0;
        width: 100%;
    }

    .navbar ul li a {
        padding: 1rem;
        border-radius: 0;
    }

    .navbar .toggle {
        display: block;
        align-self: flex-end;
        position: absolute;
        top: 1rem;
        right: 1rem;
    }

    .navbar .logo {
        margin-bottom: 1rem;
    }
}

/* Additional styles to ensure navbar doesn't overlap content and footer stays at bottom */
body {
    padding-top: 60px; /* Adjust this value based on your navbar height */
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

main {
    flex: 1 0 auto;
}

@media (max-width: 768px) {
    body {
        padding-top: 100px; /* Increase padding for mobile view */
    }
}

 /* Add these new styles */
 .analysis-wrapper {
        page-break-inside: avoid;
    }

    .analysis-section {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
    }

    .analysis-section > div {
        flex-basis: 100%;
        margin-bottom: 20px;
    }

    .analysis-section table {
        font-size: 10pt; /* Reduce font size to fit more content */
    }

    .analysis-section h3 {
        margin-top: 10px;
        margin-bottom: 5px;
    }
    .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.6);
    backdrop-filter: blur(5px);
}

.modal-content {
    background: linear-gradient(135deg, #FFA500, #D2691E);
    margin: 15% auto;
    padding: 30px;
    border: none;
    border-radius: 15px;
    width: 90%;
    max-width: 500px;
    text-align: center;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    color: white;
    font-family: Arial, sans-serif;
}

.modal-content h2 {
    margin-top: 0;
    font-size: 24px;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}

.modal-content p {
    font-size: 16px;
    margin-bottom: 15px;
}

#countdown {
    font-size: 24px;
    font-weight: bold;
    color: #FFD700;
}

#cancelRefresh {
    margin-top: 20px;
    padding: 10px 20px;
    background-color: rgba(255,255,255,0.2);
    color: white;
    border: 2px solid white;
    border-radius: 25px;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s ease;
}

#cancelRefresh:hover {
    background-color: white;
    color: #D2691E;
}
.name-options {
    display: none;
    margin-left: 10px;
}

.name-options button {
    padding: 2px 5px;
    margin-right: 5px;
    cursor: pointer;
}

.model {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.model-content {
    background: linear-gradient(135deg, #FFA500, #8B4513);
    padding: 30px;
    border-radius: 10px;
    text-align: center;
    color: white;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    max-width: 400px;
    width: 90%;
}

.model-content h2 {
    margin-bottom: 20px;
    font-size: 24px;
}

#editNameInput {
    width: 100%;
    padding: 10px;
    margin-bottom: 20px;
    font-size: 18px;
    border: none;
    border-radius: 5px;
    background-color: rgba(255, 255, 255, 0.9);
}

.model-buttons {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    gap: 15px;
}

.model-buttons button {
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
    border: none;
    border-radius: 5px;
    transition: background-color 0.3s, transform 0.1s;
}

#confirmButton {
    background-color: #4CAF50;
    color: white;
}

#confirmButton:hover {
    background-color: #45a049;
}

#cancelButton {
    background-color: #f44336;
    color: white;
}

#cancelButton:hover {
    background-color: #da190b;
}

.model-buttons button:active {
    transform: scale(0.98);
}

.flash-message {
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #FF8C00;
    color: white;
    padding: 15px;
    border-radius: 5px;
    z-index: 1001;
    transition: opacity 0.5s;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.flash-message.fade-out {
    opacity: 0;
}
#excelConversionModal {
        display: none;
        position: fixed;
        z-index: 1000;  /* Ensure it's above other elements */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }

    #excelConversionModal .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
    }

    #excelConversionModal h2 {
        margin-top: 0;
    }

    #excelConversionModal input[type="file"] {
        margin: 10px 0;
    }

    #excelConversionModal button {
        margin: 5px;
        padding: 5px 10px;
    }
    .flash-notification {
    display: none;
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #4CAF50;
    color: white;
    padding: 16px;
    border-radius: 4px;
    z-index: 1001;
}

#internetConnectionModal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
}

#internetConnectionModal .modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 500px;
}
.flash-notification {
        display: none;
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px;
        border-radius: 4px;
        z-index: 1001;
        color: white;
        font-weight: bold;
    }

    .flash-notification.success {
        background-color: #4CAF50; /* Green */
    }

    .flash-notification.error {
        background-color: #f44336; /* Red */
    }
    #connectionSuggestions {
    list-style-type: none;
    padding-left: 0;
    margin-top: 15px;
}

#connectionSuggestions li {
    margin-bottom: 5px;
    font-size: 14px;
    color: #666;
}
@media print {
        #convertToExcelBtn {
            display: none;
        }
    }
    /* Loading spinner styles */
.loading-spinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }

        .loading-spinner.show {
            opacity: 1;
            pointer-events: auto;
        }

        .lds-ring {
            display: inline-block;
            position: relative;
            width: 80px;
            height: 80px;
        }

        .lds-ring div {
            box-sizing: border-box;
            display: block;
            position: absolute;
            width: 64px;
            height: 64px;
            margin: 8px;
            border: 8px solid;
            border-radius: 50%;
            animation: lds-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            border-color: #ff6b6b transparent transparent transparent;
        }

        .lds-ring div:nth-child(1) {
            border-color: #ff6b6b transparent transparent transparent;
            animation-delay: -0.45s;
        }

        .lds-ring div:nth-child(2) {
            border-color: #ffa500 transparent transparent transparent;
            animation-delay: -0.3s;
        }

        .lds-ring div:nth-child(3) {
            border-color: #ffff00 transparent transparent transparent;
            animation-delay: -0.15s;
        }

        .lds-ring div:nth-child(4) {
            border-color: #00ff00 transparent transparent transparent;
        }

        @keyframes lds-ring {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
<!-- Loading spinner -->
<div class="loading-spinner" id="loading-spinner">
    <div class="lds-ring">
        <div></div>
        <div></div>
        <div></div>
        <div></div>
    </div>
</div>
<script>
 function showSpinner() {
            const loadingSpinner = document.getElementById('loading-spinner');
            loadingSpinner.classList.add('show');
        }

        function hideSpinner() {
            const loadingSpinner = document.getElementById('loading-spinner');
            loadingSpinner.classList.remove('show');
        }

        // Handle clicks on navigation items
        document.addEventListener('click', (event) => {
            const target = event.target.closest('a');
            if (target && target.getAttribute('href') && 
                !target.getAttribute('href').startsWith('#') && 
                !target.getAttribute('target') &&
                target.getAttribute('href') !== 'javascript:void(0);') {
                event.preventDefault();
                showSpinner();
                setTimeout(() => {
                    window.location.href = target.getAttribute('href');
                }, 500); // Delay of 500ms to simulate loading
            }
        });

        // Modify your checkAuth function
        function checkAuth(url) {
            // Your authentication logic here
            const isAuthenticated = true; // Replace with your actual auth check

            if (isAuthenticated) {
                showSpinner();
                setTimeout(() => {
                    window.location.href = url;
                }, 500);
            } else {
                // Show login message or redirect to login page
                document.getElementById('login-message').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('login-message').style.display = 'none';
                }, 3000);
            }
        }
</script>
     <!-- Add the navbar -->
     <!-- <div class="navbar">
        <div class="logo">
            <img src="schoologo-2-150x150.png" alt="School Logo">
            <div class="title animated-title">Glorious Schools</div>
        </div>
        <span class="toggle" onclick="toggleMenu()">&#9776;</span>
        <ul id="nav-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="javascript:void(0);" onclick="checkAuth('games.html')">Games</a></li>
            <li><a href="javascript:void(0);" onclick="checkAuth('videos.html')">Videos</a></li>     
            <li><a href="javascript:void(0);" onclick="checkAuth('library.html')">Library</a></li>
            <li id="logout-nav" style="display: none;"><button class="logout-button" onclick="logout()">Logout</button></li>
        </ul>
    </div> -->
        <div class="pdf-title">
            <h2>GLORIOUS KINDERGARTEN AND PRIMARY SCHOOL</h2>
            <h2>___________ EXAMS RESULTS TERM ___________ 2024</h2>
            <h2 id="classStreamTitle"></h2>

        </div>
    
    <div class="container">
        <div id="welcomePage" class="card">
            <center>
                <img src="schoologo-2-150x150.png" alt="School Logo" class="logo">
                <h1>Glorious Examinations Board</h1>
            </center>
            <h2>Select Class and Stream</h2>
            <div class="select-container">
                <select id="classSelect">
                    <option value="" disabled selected>Select Class</option>
                </select>
                <select id="streamSelect" style="display: none;">
                    <option value="" disabled selected>Select Stream</option>
                </select>
                <button id="goToGradingBtn" style="display: none;">Go to Grading</button>
            </div>
        </div>
        <div id="pdfModal" class="modal">
            <div class="modal-content">
                <h2>PDF Generated Successfully ✔️</h2>
                <p>The PDF file has been saved to your device.</p>
                <p>Returning to the start page in <span id="countdown">5</span> seconds.</p>
                <button id="cancelRefresh">Stay on this page</button>
            </div>
        </div>
        <div id="gradingPage" style="display: none;">
            <div class="card">
                <table id="gradeTable">
                    <thead id="gradeTableHeader">
                        <!-- The header will be dynamically populated -->
                    </thead>
                    <tbody id="gradeTableBody">
                        <!-- Student rows will be added here dynamically -->
                    </tbody>
                </table>

            <button id="saveJsonBtn" style="margin-top: 20px;">Export as JSON { }</button>
            <button id="importJsonBtn" style="margin-top: 20px;">Import JSON { }</button>
            <button id="convertToExcelBtn" style="margin-top: 20px;">Convert to Excel 📊</button>
              <button id="generatePdfBtn" style="margin-top: 20px;">Print Preview 🖶</button>
            <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
            
            <input type="file" id="fileInput" accept=".json" style="display: none;">
             </div>

<!-- No Internet Connection Modal -->
<div id="internetConnectionModal" class="modal">
    <div class="modal-content">
        <h2>No Internet Connection 🌐 </h2>
        <p>You appear to be offline. Some functionalities may not work.</p>
        
        <button onclick="retryConnection()">Retry</button>
        <button onclick="closeInternetConnectionModal()">Close</button>
        <h3>Here are some friendly suggestions:</h3>
        <ul id="connectionSuggestions">
            <li>Turn on Wi-Fi</li>
            <li>Check if you're in airplane mode</li>
            <li>Restart your router</li>
            <li>Move closer to your Wi-Fi router</li>
            <li>Try connecting to a different network</li>
        </ul>
    </div>
</div>

<!-- Excel Conversion Modal -->
<div id="excelConversionModal" class="modal">
    <div class="modal-content">
        <h2>Convert JSON to Excel</h2>
        <input type="file" id="jsonExcelInput" accept=".json">
        <button onclick="convertToExcel()">Convert</button>
        <button onclick="closeExcelConversionModal()">Cancel</button>
    </div>
</div>
<script>

    // navbar-script.js
function toggleMenu() {
    const navLinks = document.getElementById('nav-links');
    navLinks.classList.toggle('show');
}

function logout() {
    localStorage.removeItem("rememberMe");
    localStorage.removeItem("email");
    localStorage.removeItem("password");
    localStorage.removeItem("isLoggedIn");
    sessionStorage.removeItem("email");
    sessionStorage.removeItem("password");
    sessionStorage.removeItem("isLoggedIn");
    sessionStorage.removeItem("intendedPage");
    window.location.href = 'index.html';
}

function checkAuth(page) {
    if (localStorage.getItem('isLoggedIn') === 'true' || sessionStorage.getItem('isLoggedIn') === 'true') {
        window.location.href = page;
    } else {
        sessionStorage.setItem("intendedPage", page);
        showLoginMessage();
    }
}

function showLoginMessage() {
    // Implement this function if you want to show a login message
    console.log("Please log in to access this page.");
}

function checkAuthStatus() {
    const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true' || sessionStorage.getItem('isLoggedIn') === 'true';
    document.getElementById("logout-nav").style.display = isLoggedIn ? "block" : "none";
}

document.addEventListener("DOMContentLoaded", function() {
    checkAuthStatus();
    document.getElementById('currentYear').textContent = new Date().getFullYear();
});
</script>
<!-- Flash Notification -->
<div id="flashNotification" class="flash-notification">
    <p id="flashMessage"></p>
</div>


             <div class="analysis-wrapper">
                <div class="analysis-section">
                    <h3>Division Analysis</h3>
                    <table id="divisionAnalysisTable">
                        <thead>
                            <tr>
                                <th>Division</th>
                                <th>Number of Pupils</th>
                                <th>%</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Division analysis rows will be added here dynamically -->
                        </tbody>
                    </table>
            
            
                <h3>Aggregate Analysis</h3>
                <table id="aggregateAnalysisTable">
                    <thead>
                        <tr id="aggregateRow">
                            <th>AGGREGATE:</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="pupilCountRow">
                            <th>NUMBER OF PUPILS:</th>
                        </tr>
                    </tbody>
                </table>
            
                <h3>Subject Analysis</h3>
                <table id="subjectAnalysisTable">
                    <thead>
                        <tr>
                            <th>Subject</th>
                            <th>D1</th>
                            <th>D2</th>
                            <th>C3</th>
                            <th>C4</th>
                            <th>C5</th>
                            <th>C6</th>
                            <th>P7</th>
                            <th>P8</th>
                            <th>F9</th>
                            <th>X</th>
                            <th>1st Grades</th>
                            <th>%</th>
                            <th>POS</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Subject analysis rows will be added here dynamically -->
                    </tbody>
                </table>
                <h3>Approval Section</h3>
                <table id="approvalTable">
                    <tbody>
                        <tr>
                            <th>Class Teacher's Comment:</th>
                            <td></td>
                        </tr>
                        <tr>
                            <th>Class Teacher's Name:</th>
                            <td></td>
                        </tr>
                        <tr>
                            <th>Class Teacher's Signature:</th>
                            <td></td>
                        </tr>
                        <tr>
                            <th>Date of Submission:</th>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
                
            </div>
            </div>
<!-- Add the footer -->
<br><br>
<footer class="footer">
    
    <div>
        <p>&copy; Glorious Schools <span id="currentYear"></span></p>
    </div>
</footer>
    <script>
let isOnline = navigator.onLine;
let currentOpenModal = null;

function showFlashNotification(message, isSuccess) {
    const flashNotification = document.getElementById('flashNotification');
    const flashMessage = document.getElementById('flashMessage');
    flashMessage.textContent = message;
    
    // Remove any existing classes
    flashNotification.classList.remove('success', 'error');
    
    // Add the appropriate class based on the message type
    if (isSuccess) {
        flashNotification.classList.add('success');
    } else {
        flashNotification.classList.add('error');
    }
    
    flashNotification.style.display = 'block';
    setTimeout(() => {
        flashNotification.style.display = 'none';
    }, 3000);
}

function checkInternetConnection() {
    if (navigator.onLine) {
        if (!isOnline) {
            showFlashNotification("Internet connection received 📡", true);
            isOnline = true;
            if (currentOpenModal === 'internetConnectionModal') {
                closeInternetConnectionModal();
                openExcelConversionModal();
            }
        }
    } else {
        if (isOnline) {
            showFlashNotification("Internet connection lost 📶", false);
            isOnline = false;
            if (currentOpenModal === 'excelConversionModal') {
                closeExcelConversionModal();
                openInternetConnectionModal();
            }
        }
    }
}

function openInternetConnectionModal() {
    document.getElementById('internetConnectionModal').style.display = 'block';
    currentOpenModal = 'internetConnectionModal';
}

function closeInternetConnectionModal() {
    document.getElementById('internetConnectionModal').style.display = 'none';
    currentOpenModal = null;
}

function openExcelConversionModal() {
    document.getElementById('excelConversionModal').style.display = 'block';
    document.getElementById('jsonExcelInput').value = '';
    currentOpenModal = 'excelConversionModal';
}

function closeExcelConversionModal() {
    document.getElementById('excelConversionModal').style.display = 'none';
    currentOpenModal = null;
}

function retryConnection() {
    checkInternetConnection();
    if (isOnline) {
        closeInternetConnectionModal();
        openExcelConversionModal();
    } else {
        showFlashNotification("Still no internet connection 😔", false);
    }
}

document.getElementById('convertToExcelBtn').addEventListener('click', function() {
    if (navigator.onLine) {
        openExcelConversionModal();
    } else {
        openInternetConnectionModal();
    }
});

function convertToExcel() {
    if (!navigator.onLine) {
        openInternetConnectionModal();
        return;
    }

    const fileInput = document.getElementById('jsonExcelInput');
    const file = fileInput.files[0];

    if (!file) {
        alert('Please select a JSON file.');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        let data;
        try {
            data = JSON.parse(e.target.result);
        } catch (error) {
            alert('Invalid JSON file. Please check your input.');
            return;
        }

        const schoolName = "GLORIOUS KINDERGARTEN & PRIMARY SCHOOL";
        const className = data.class;
        const stream = data.stream;
        const students = data.students;

        // Determine the format based on the first student's data
        const format = students[0].hasOwnProperty('scie') ? 'original' : 'new';

        // Create headers based on the format
        let headers;
        if (format === 'original') {
            headers = ['Name', 'English', 'Grade', 'Mathematics', 'Grade', 'Science', 'Grade', 
                       'Social Studies', 'Grade', 'ICT', 'Grade', 'Kiswahili', 'Grade', 
                       'Total Aggregates', 'Division'];
        } else {
            headers = ['Name', 'English', 'Grade', 'Mathematics', 'Grade', 'Literature A', 'Literature B', 
                       'Literature Avg', 'Literature Grade', 'RE', 'Grade', 'Literature 2', 'Grade', 
                       'Luganda', 'Grade', 'Total Aggregates', 'Division'];
        }

        // Create worksheet
        const ws = XLSX.utils.aoa_to_sheet([
            [schoolName],
            [`Class: ${className}`, `Stream: ${stream}`],
            [],  // Empty row for spacing
            headers
        ]);

        // Add student data
        const studentData = students.map(student => {
            if (format === 'original') {
                return [
                    student.name,
                    student.eng.marks, student.eng.grade,
                    student.mtc.marks, student.mtc.grade,
                    student.scie.marks, student.scie.grade,
                    student.sst.marks, student.sst.grade,
                    student.ict.marks, student.ict.grade,
                    student.kisw.marks, student.kisw.grade,
                    student.totalAggregates,
                    student.division
                ];
            } else {
                return [
                    student.name,
                    student.eng.marks, student.eng.grade,
                    student.mtc.marks, student.mtc.grade,
                    student.lit.a.marks,
                    student.lit.b.marks,
                    student.lit.avg,
                    student.lit.grade,
                    student.re.marks, student.re.grade,
                    student.lit2.marks, student.lit2.grade,
                    student.lug.marks, student.lug.grade,
                    student.totalAggregates,
                    student.division
                ];
            }
        });

        XLSX.utils.sheet_add_aoa(ws, studentData, {origin: -1});

        // Set column widths
        const cols = Array(headers.length).fill({wch: 15});
        cols[0] = {wch: 30};  // Name column
        ws['!cols'] = cols;

        // Make header bold
        ['A1', 'A2', 'B2'].forEach(cell => {
            if (!ws[cell]) ws[cell] = {};
            ws[cell].s = { font: { bold: true } };
        });

        // Make column headers bold
        for (let i = 0; i < headers.length; i++) {
            const cell = XLSX.utils.encode_cell({r: 3, c: i});
            if (!ws[cell]) ws[cell] = {};
            ws[cell].s = { font: { bold: true } };
        }

        // Create workbook and add the worksheet
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Students");

        // Generate Excel file with class name and stream as file name
        const fileName = `${className}_${stream}.xlsx`.replace(/\s+/g, '_');
        XLSX.writeFile(wb, fileName);

        // Clear the file input after successful conversion
        fileInput.value = '';

        closeExcelConversionModal();
    };

    reader.readAsText(file);
}

// Check internet connection status every 5 seconds
setInterval(checkInternetConnection, 5000);

// Initial check when the page loads
window.addEventListener('load', checkInternetConnection);

// Listen for online/offline events
window.addEventListener('online', checkInternetConnection);
window.addEventListener('offline', checkInternetConnection);

function updateAnalysisTables() {
    // Clear existing data
    document.getElementById('divisionAnalysisTable').getElementsByTagName('tbody')[0].innerHTML = '';
    document.getElementById('aggregateAnalysisTable').getElementsByTagName('tbody')[0].innerHTML = '';
    document.getElementById('subjectAnalysisTable').getElementsByTagName('tbody')[0].innerHTML = '';

    // Recalculate and update tables
    updateDivisionAnalysisTable();
    updateAggregateAnalysisTable();
    updateSubjectAnalysisTable();
}

function importJSON() {
    document.getElementById('jsonFileInput').click();
}

document.getElementById('jsonFileInput').addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                populateTableFromJSON(data);
                showNotification("JSON data imported successfully!", "success");
                updateAnalysisTables();
            } catch (error) {
                console.error('Error parsing JSON:', error);
                showNotification("Error importing JSON. Please check the file format.", "error");
            }
        };
        reader.readAsText(file);
    }
});



function populateTableFromJSON(data) {
    if (!data.class || !data.stream || !Array.isArray(data.students)) {
        throw new Error("Invalid JSON structure");
    }

    classSelect.value = data.class;
    populateStreamSelect(data.class);
    streamSelect.value = data.stream;
    classStreamTitle.textContent = `${data.class} - ${data.stream}`;

    const tableBody = document.getElementById('gradeTableBody');
    tableBody.innerHTML = '';

    data.students.forEach((student, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${index + 1}. <span class="student-name">${student.name || ''}</span></td>
            <td><input type="text" class="subject-mark main-subject" value="${student.eng?.marks || ''}" required pattern="^\\d+$|^-$" maxlength="3"></td>
            <td class="subject-aggregate">${student.eng?.grade || ''}</td>
            <td><input type="text" class="subject-mark main-subject" value="${student.mtc?.marks || ''}" required pattern="^\\d+$|^-$" maxlength="3"></td>
            <td class="subject-aggregate">${student.mtc?.grade || ''}</td>
            <td><input type="text" class="subject-mark main-subject" value="${student.scie?.marks || ''}" required pattern="^\\d+$|^-$" maxlength="3"></td>
            <td class="subject-aggregate">${student.scie?.grade || ''}</td>
            <td><input type="text" class="subject-mark main-subject" value="${student.sst?.marks || ''}" required pattern="^\\d+$|^-$" maxlength="3"></td>
            <td class="subject-aggregate">${student.sst?.grade || ''}</td>
            ${student.ict ? `
                <td><input type="text" class="subject-mark minor-subject" value="${student.ict.marks || ''}" pattern="^\\d+$|^-$" maxlength="3"></td>
                <td class="subject-aggregate minor-subject">${student.ict.grade || ''}</td>
            ` : ''}
            ${student.kisw ? `
                <td><input type="text" class="subject-mark minor-subject" value="${student.kisw.marks || ''}" pattern="^\\d+$|^-$" maxlength="3"></td>
                <td class="subject-aggregate minor-subject">${student.kisw.grade || ''}</td>
            ` : ''}
            <td class="total-aggregates">${student.totalAggregates || ''}</td>
            <td class="division">${student.division || ''}</td>
        `;
        tableBody.appendChild(row);
    });

    addInputEventListeners();
    
    welcomePage.style.display = 'none';
    gradingPage.style.display = 'block';
}

function addInputEventListeners() {
    const inputs = document.querySelectorAll('.subject-mark');
    inputs.forEach((input, index) => {
        input.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9-]/g, '');
            validateAndUpdateResults(this);
            
            const numValue = parseInt(this.value);
            if ((numValue > 10 && numValue < 100) || this.value === '-' || this.value === '100') {
                if (index < inputs.length - 1) {
                    inputs[index + 1].focus();
                }
            }
        });
        
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === 'ArrowRight') {
                e.preventDefault();
                if (index < inputs.length - 1) {
                    inputs[index + 1].focus();
                }
            } else if (e.key === 'ArrowLeft') {
                e.preventDefault();
                if (index > 0) {
                    inputs[index - 1].focus();
                }
            }
        });
        
        input.addEventListener('blur', () => validateAndUpdateResults(input));
    });
}

document.getElementById('importJsonBtn').addEventListener('click', importJSON);

function saveTableAsJSON() {
    const selectedClass = classSelect.value;
    const selectedStream = streamSelect.value;
    const table = document.getElementById('gradeTable');
    let data = {
        class: selectedClass,
        stream: selectedStream,
        students: []
    };

    const rows = table.querySelectorAll('tr:not(:first-child)');
    
    rows.forEach((row, index) => {
        let studentData = {};
        const cells = row.querySelectorAll('td');
        
        studentData.name = cells[0].querySelector('.student-name').textContent.trim();
        
        const subjects = ['eng', 'mtc', 'scie', 'sst'];
        subjects.forEach((subject, i) => {
            studentData[subject] = {
                marks: cells[i * 2 + 1].querySelector('input').value,
                grade: cells[i * 2 + 2].textContent.trim()
            };
        });

        if (cells.length > 9) {
            const minorSubjects = ['ict', 'kisw'];
            minorSubjects.forEach((subject, i) => {
                const cellIndex = 9 + i * 2;
                if (cells[cellIndex]) {
                    studentData[subject] = {
                        marks: cells[cellIndex].querySelector('input').value,
                        grade: cells[cellIndex + 1].textContent.trim()
                    };
                }
            });
        }

        studentData.totalAggregates = cells[cells.length - 2].textContent.trim();
        studentData.division = cells[cells.length - 1].textContent.trim();

        data.students.push(studentData);
    });

    const jsonContent = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonContent], { type: 'application/json' });
    const link = document.createElement("a");
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `${selectedClass}_${selectedStream}_Results.json`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }
}

document.getElementById('saveJsonBtn').addEventListener('click', saveTableAsJSON);


function generatePDF() {
    const welcomePage = document.getElementById('welcomePage');
    const fileInput = document.getElementById('fileInput');
    const generatePdfBtn = document.getElementById('generatePdfBtn');

    welcomePage.style.display = 'none';
    fileInput.style.display = 'none';
    generatePdfBtn.style.display = 'none';

    const gradingPage = document.getElementById('gradingPage');
    gradingPage.style.display = 'block';

    window.print();

    setTimeout(() => {
        welcomePage.style.display = 'block';
        fileInput.style.display = 'inline-block';
        generatePdfBtn.style.display = 'inline-block';

        showModal();
    }, 100);
}

function showModal() {
    const modal = document.getElementById('pdfModal');
    const countdown = document.getElementById('countdown');
    const cancelBtn = document.getElementById('cancelRefresh');
    let secondsLeft = 5;

    modal.style.display = 'block';

    const countdownInterval = setInterval(() => {
        secondsLeft--;
        countdown.textContent = secondsLeft;

        if (secondsLeft <= 0) {
            clearInterval(countdownInterval);
            location.reload();
        }
    }, 1000);

    cancelBtn.onclick = () => {
        clearInterval(countdownInterval);
        modal.style.display = 'none';
    };
}

document.getElementById('generatePdfBtn').addEventListener('click', generatePDF);
        function updateAnalysisTables() {
    updateDivisionAnalysisTable();
    updateAggregateAnalysisTable();
    updateSubjectAnalysisTable();
    
}

function updateDivisionAnalysisTable() {
    const table = document.getElementById('divisionAnalysisTable').getElementsByTagName('tbody')[0];
    table.innerHTML = '';

    const divisionCounts = {
        '1': 0,
        '2': 0,
        '3': 0,
        '4': 0,
        'U': 0,
        'X': 0
    };

    const divisionCells = document.querySelectorAll('#gradeTable .division');

    divisionCells.forEach(cell => {
        const division = cell.textContent.trim();
        if (division in divisionCounts) {
            divisionCounts[division]++;
        }
    });

    // Calculate total number of pupils
    const totalStudents = Object.values(divisionCounts).reduce((sum, count) => sum + count, 0);

    Object.entries(divisionCounts).forEach(([division, count]) => {
        const row = table.insertRow();
        row.insertCell().textContent = division;
        row.insertCell().textContent = count;
        
        // Calculate and add percentage
        if (totalStudents > 0) {
            const percentage = ((count / totalStudents) * 100).toFixed(2);
            row.insertCell().textContent = `${percentage}%`;
        } else {
            row.insertCell().textContent = '0%';
        }
    });
}

function updateAggregateAnalysisTable() {
    const aggregateRow = document.getElementById('aggregateRow');
    const pupilCountRow = document.getElementById('pupilCountRow');
    
    // Clear existing data
    while (aggregateRow.children.length > 1) {
        aggregateRow.removeChild(aggregateRow.lastChild);
    }
    while (pupilCountRow.children.length > 1) {
        pupilCountRow.removeChild(pupilCountRow.lastChild);
    }

    const aggregateCounts = {};
    const totalAggregateCells = document.querySelectorAll('#gradeTable .total-aggregates');

    totalAggregateCells.forEach(cell => {
        const aggregate = cell.textContent.trim();
        if (aggregate) {
            aggregateCounts[aggregate] = (aggregateCounts[aggregate] || 0) + 1;
        }
    });

    Object.entries(aggregateCounts).sort((a, b) => parseInt(a[0]) - parseInt(b[0])).forEach(([aggregate, count]) => {
        const aggregateTh = document.createElement('th');
        aggregateTh.textContent = aggregate;
        aggregateRow.appendChild(aggregateTh);

        const countTd = document.createElement('td');
        countTd.textContent = count;
        pupilCountRow.appendChild(countTd);
    });
}

function updateSubjectAnalysisTable() {
    const table = document.getElementById('subjectAnalysisTable').getElementsByTagName('tbody')[0];
    table.innerHTML = '';

    const subjects = ['ENG', 'MTC', 'SCIE', 'SST'];
    const grades = ['D1', 'D2', 'C3', 'C4', 'C5', 'C6', 'P7', 'P8', 'F9', 'X'];

    // Get total number of pupils
    const totalPupils = document.querySelectorAll('#gradeTable tbody tr').length;

    const subjectData = {};

    subjects.forEach(subject => {
        const row = table.insertRow();
        row.insertCell().textContent = subject;

        const counts = grades.map(grade => countGradesForSubject(subject, grade));
        counts.forEach(count => {
            row.insertCell().textContent = count;
        });

        const firstGradesCount = counts[0] + counts[1] + counts[2]; // D1 + D2 + C3 count
        row.insertCell().textContent = firstGradesCount;

        // Calculate percentage
        const percentage = (firstGradesCount / totalPupils) * 100;
        row.insertCell().textContent = percentage.toFixed(2) + '%';

        // Calculate POINTS for Primary Seven
        const selectedClass = classSelect.value;
        if (selectedClass === 'Primary Seven') {
            const points = calculateSubjectPoints(counts, totalPupils);
            row.insertCell().textContent = points.toFixed(2);
        }

        subjectData[subject] = {
            firstGradesCount: firstGradesCount,
            points: selectedClass === 'Primary Seven' ? calculateSubjectPoints(counts, totalPupils) : 0
        };
    });

    const subjectPositions = calculateSubjectPositions(subjectData);

    // Add subject positions
    Array.from(table.rows).forEach((row, index) => {
        const subject = subjects[index];
        row.insertCell().textContent = subjectPositions[subject];
    });
}

function calculateSubjectPoints(counts, totalPupils) {
    const d1Count = counts[0];
    const d2Count = counts[1];
    const c3Count = counts[2];

    const d1Points = (d1Count / totalPupils) * 1000;
    const d2Points = ((d2Count / (totalPupils - d1Count)) * 500) || 0;
    const c3Points = ((c3Count / (totalPupils - d1Count - d2Count)) * 300) || 0;

    return d1Points + d2Points + c3Points;
}

function countGradesForSubject(subject, grade) {
    const subjectIndex = ['ENG', 'MTC', 'SCIE', 'SST'].indexOf(subject) * 2 + 2;
    const cells = document.querySelectorAll(`#gradeTable td:nth-child(${subjectIndex + 1})`);
    return Array.from(cells).filter(cell => cell.textContent.trim().startsWith(grade)).length;
}

function calculateSubjectPositions(subjectData) {
    const selectedClass = classSelect.value;
    const isPrimarySeven = selectedClass === 'Primary Seven';

    const sortedSubjects = Object.entries(subjectData)
        .sort(([, a], [, b]) => {
            if (isPrimarySeven) {
                return b.points - a.points;
            } else {
                return b.firstGradesCount - a.firstGradesCount;
            }
        });

    const positions = {};
    let currentPosition = 1;
    let previousScore = null;

    sortedSubjects.forEach(([subject, data], index) => {
        const currentScore = isPrimarySeven ? data.points : data.firstGradesCount;
        if (currentScore !== previousScore) {
            currentPosition = index + 1;
        }
        positions[subject] = currentPosition;
        previousScore = currentScore;
    });

    return positions;
}

        function showNotification(message, type = 'info', duration = 3000) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;

    const progressBar = document.createElement('div');
    progressBar.className = 'progress-bar';
    const progress = document.createElement('div');
    progress.className = 'progress';
    progressBar.appendChild(progress);
    notification.appendChild(progressBar);

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.opacity = '1';
    }, 10);

    setTimeout(() => {
        progress.style.width = '100%';
    }, 50);

    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, duration);
}
   

function checkImportCancelled() {
    const fileInput = document.getElementById('fileInput');
    if (filePickerOpened && !fileInput.value) {
        showNotification("Import cancelled", "info");
    }
    filePickerOpened = false;
    window.removeEventListener('focus', checkImportCancelled);
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const jsonData = JSON.parse(e.target.result);
                populateTableWithImportedData(jsonData);
                showNotification("Data imported successfully!", "success");
            } catch (error) {
                console.error('Error parsing JSON:', error);
                showNotification("Error importing data. Please make sure the file is a valid JSON.", "error");
            }
        };
        reader.readAsText(file);
    }
    // Reset the file input to allow re-importing the same file
    event.target.value = '';
}

      function populateTableWithImportedData(data) {
    // Set the class and stream selects
    classSelect.value = data.class;
    populateStreamSelect(data.class);
    streamSelect.value = data.stream;

    // Show the grading page
    welcomePage.style.display = 'none';
    gradingPage.style.display = 'block';

    // Set the title
    classStreamTitle.textContent = `${data.class} - ${data.stream}`;

    // Clear existing table rows
    const tableBody = document.getElementById('gradeTableBody');
    tableBody.innerHTML = '';

    // Populate the table with imported data
    data.students.forEach(student => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${student.name}</td>
            <td><input type="text" class="subject-mark" value="${student.math.marks}" required pattern="^\\d+$|^-$" maxlength="3"></td>
            <td class="subject-aggregate">${student.math.marks ? student.math.grade : ''}</td>
            <td><input type="text" class="subject-mark" value="${student.english.marks}" required pattern="^\\d+$|^-$" maxlength="3"></td>
            <td class="subject-aggregate">${student.english.marks ? student.english.grade : ''}</td>
            <td><input type="text" class="subject-mark" value="${student.sst.marks}" required pattern="^\\d+$|^-$" maxlength="3"></td>
            <td class="subject-aggregate">${student.sst.marks ? student.sst.grade : ''}</td>
            <td><input type="text" class="subject-mark" value="${student.science.marks}" required pattern="^\\d+$|^-$" maxlength="3"></td>
            <td class="subject-aggregate">${student.science.marks ? student.science.grade : ''}</td>
            <td class="total-aggregates">${calculateTotalAggregates(student)}</td>
            <td class="division">${calculateDivision(calculateTotalAggregates(student))}</td>
        `;

        const inputs = row.querySelectorAll('.subject-mark');
        inputs.forEach(input => {
            input.addEventListener('input', function() {
                this.value = this.value.replace(/[^0-9-]/g, '');
                validateAndUpdateResults(this);
            });
            input.addEventListener('blur', () => validateAndUpdateResults(input));
        });

        tableBody.appendChild(row);
    });

    // Trigger update for all inputs to recalculate grades and aggregates
    tableBody.querySelectorAll('.subject-mark').forEach(input => {
        validateAndUpdateResults(input);
    });
}

const studentData = {
    'Primary Four': {
    'Cubs': [
      'AHEREZA HONOUR',
      'ALIYAH ADAMS K.',
      'AKARABO GOLDA',
      'BLESSING SHILOH',
      'AINOMUGISHA ANGEL',
      'KEMIGISHA ALEXANDRIA',
      'LUBUULWA MELINA J',
      'MUBEEZI SHADIA L.',
      'NAKUNGU PRECIOUS',
      'NASSANGA MARIA A.',
      'NAMIREMBE ALPHA',
      'NANUNGI DRUCILLA L.',
      'NAMAGANDA IMRAH',
      'NAKAWEESI MICHELLE',
      'NAMUTEBI GERTRUDE',
      'NANJOBE VANESSA',
      'NINSIIMA MARY S.',
      'NVANUNGI SHANIEZ F.',
      'TEMITOPE GRACE A.',
      'ASHABA ELIZABETH',
      'NANSUBUGA MANUELLA',
      'NAMAKULA SOPHIA',
      'OBANG SHALLOM S.',
      'BUKIRWA LETICIA',
      'KISMART DAUDA',
      'KASOZI AAMRAT',
      'NANTONGO BUSHIRAH',
      'MOKHTA ADAM SALAM',
      'BAGONZA JOAB',
      'KAYONGO JAWAD',
      'KAKONA JORDAN',
      'KIGGUNDU LUKE',
      'BUYUNGO ERIC',
      'LUBEGA MALCOM',
      'LUKANDWA PHILLIP',
      'MURUNGI IAN',
      'MUYINZA CYRUS',
      'MULANGIRA JOSEPH',
      'MANZI EVANS',
      'ITAAGA NICHOLAST',
      'LUYIGA  RAYAN',
      'SSEWAKIRYANGA HOSEA',
      'SSUUNA RAFAN W',
      'SSEMATIMBA MARK',
      'SSEBABENGA KERON',
      'TWESIGYE ADRIAN',
      'WALLIGO ETHAN',
      'NAMWANJA JOHN BAPTIST',
      'SSENGENDO PRITA',
      'KALULE CARLOS',
      'MUHUMUZA ADHELITO',
      'LUGGYA AKRAM',
      'SSEMOMBWE ANDERSON'
    ],
    'Bunnies': [
      'BUKENYA KEITH MARTINS',
      'DDUMBA FRANCIS',
      'GITTA RAZAQ',
      'KASOZI NELSON',
      'KATEREGGA RAUL',
      'KAYEMBA SHAN',
      'KIMBUGWE MELVIN',
      'KIRABIRA ARNOLD',
      'KUTEESA ISMAIL KALULE',
      'LWANGA RAPHAEL',
      'MOYA ELISHA',
      'MUGISA VALENTE',
      'MUKISA NATHAN',
      'MUKISA SAMSON',
      'MULINDWA EDDY',
      'MURAMUZI JAN JENSEN',
      'NAJIB AL-SHAFIQ',
      'SSEKANDI RAMATHAN',
      'SSONKO HENRY ARTHUR',
      'WALUSIMBI ABDUL-SHARIK',
      'ANKUNDA DENISE',
      'ASIIMWE SHEENA',
      'ATAMBA CAROL JIREH',
      'ATUKUNDA GRAMIA',
      'AYEBAREYESU EXCELLENT',
      'BWIRE CLARRISA',
      'HIPAINGAH SALAH JOSEPHINE',
      'JIBE IMMACULATE',
      'KABANDA MARTHA',
      'KABUYAYA RAYANNA',
      'KALIBALA JANAT',
      'KAMUGISHA NATALIE',
      'KASEMIRE BLESSING',
      'KAVUMA GRACE',
      'KHARUNDA ESTHER',
      'KYAZZE MARTHA',
      'LYMIAH AVRIL SALIM',
      'MICHORO ANNA ALEXA',
      'NABAKOOZA CHRISTINE',
      'NABIKOLO ANNA',
      'NAKASUJJA SHANNAH',
      'NALUMANSI LYTON',
      'NAMALA SALSABEL',
      'NAMBI NAAVA',
      'NAMUBIRU RIAH',
      'NANDAWULA  DESIRE',
      'NANONO ROSHAN ISMAIL',
      'NINSIIMA KIRABO ARIANAH',
      'NYONYOZI EDRINAH',
      'UMUTESI DINAH INEZ',
    ],
    'Eaglets': [
      'KISAKYE MARTHA',
      'ANYANGO KAREN MERCY',
      'ASIIMWE MONICA',
      'ATUHAIRE ANGELLA',
      'BUKIRWA RAHMA DDUMBA',
      'JAMILAH PEACE ATHUMAN',
      'KATEREGGA RASHIM',
      'KAYAGA KATRINAH',
      'KEBIRUNGI DAISY EVE',
      'LUMU ANNA GRAGIOUS',
      'MUTESI TRINA TEDDY',
      'MUTUMBA AALIYAH',
      'NABAGULANYI TENDO TREASURE',
      'NABIRYE PRECIOUS',
      'NABUUMA VANESSA',
      'NAKIBUUKA ASSUMPTA',
      'NAKIBUULE MELAN BLESSED',
      'NAKITTO HAPPY DANIELLA',
      'NALUWOOZA BUSHIRAH',
      'NAMATOVU IMMACULATE',
      'NAMATOVU PROVIA ABIGAIL',
      'NAMBATYA SHIVAN',
      'NAMULINDWA VICTORIA',
      'NANTONGO SHANTEL',
      'TENDO HASIFA HAKIM',
      'UWINEZA SHAMAH ZINDUKA',
      'WASSAJJA MELISSA RAP',
      'MUTESAASIRA JOLLEN',
      'MUBIRU INAN',
      'NABBALE BLESSING V.',
      'MERCY ALLEN',
      'AVANI PATRICIA',
      'AHABWE ALVIN',
      'AINEBYONA ISAIAH',
      'AKOL LEON MASABA',
      'DDAMBA SHADRACK',
      'KAKANDE BLESSED',
      'KAWULUKUSI SHAKURAN',
      'KEVIN KHAMIS KENNEDY',
      'KIGOZI RAHEEM',
      'KITANDWE ABDULSHAKUL',
      'MATSIKO HANIF',
      'MAWEJJE UKASHA',
      'MIKKA TYABA NICHOLAS',
      'MUBIRU MIGUEL HERO',
      'MULUMBA FAVOUR CLINTON',
      'MULWANA NEAL',
      'NAMUTALE FEDERICO',
      'NSAMBA JORDAN RICH',
      'SSEJJUUKO PEDRO',
      'SSEKANJAKO ARAFAT',
      'SSETUMBA JESSIE',
      'TUSUUBIRA ARTHUR',
      'MBAZIRA JOEL',
      'MBABAZI CYROH',
      'MPANGA FAHAD',
      'RWOMUSHANA OMUGISHA G.',
    ]
  },
  'Primary Five': {
  'Sunset': [
    'AHABWE JOSIAH',
    'AMUGE LYNDSEY MILES',
    'ATULINDA AISHA',
    'AYEBARE MELLISA',
    'BATARINGAYA SHIMARO',
    'BUKIRWA SHAMRA DDUMBA',
    'BULEGA PIUS',
    'JAZMINE BIDS',
    'JJAGWE JOVAN',
    'JJUMBA ANGELLO',
    'KAKOOZA DIVINE MACKYLA',
    'KALUNGI JONATHAN',
    'KAREMERA ABDUL HANAN',
    'KATENDE HAMIR',
    'KATONO ALLAN',
    'KAZIBA JOSHUA',
    'KIGGUNDU LIA',
    'KIMBUGWE HASSAN AWADH',
    'KIRABO EVAS',
    'KIZZA JOYCE MYER SEMPA',
    'KYALIGONZA HARVEY RENATAH',
    'LUBWAMA MARTIN WASSWA',
    'LUKWAGO LUCKY AHMET',
    'LWANGA WYCLIFF',
    'MAKIKA MEEKSON',
    'MUBIRU RAJAB',
    'MUKISA PHILEMON',
    'MULWANA JONATHAN',
    'MUSASIZI ADRIAN',
    'MUWONGE PENIEL',
    'MWEBAZA PEACE DIVINE',
    'NABWIRE GLORIA MICHELLE',
    'NAGAWA ANTHONIA BEATRICE',
    'NAKAWEKE JANE',
    'NAKITTO MYRA REMEDY',
    'NAKIYEMBA SHUKRAH',
    'NAMAGANDA JULIANA TENDO',
    'NAMARA REBECCA BLESSED',
    'NAMAWEJJE ELIZABETH SHANTAL',
    'NAMIREMBE KAHLAN MARTHA',
    'NAMPIJJA PATRICIA',
    'NAMUGENYI HELLEN',
    'NAMUSISI MARIA FEDERESI',
    'NAMWANJE MACRINAH',
    'NANYONJO HALIMAH',
    'NASSUUNA WILDER',
    'NYIRANEZA VIVIAN',
    'ODONG DAVID ISA',
    'OPIO DANIEL OPOLOT',
    'OWARUHANGA JONATHAN KAHIIRWA',
    'SSERUNKUMA ABRIELLE PROSPER',
    'TUMUSIIME ELIJAH'
  ],
  'Sunrise': [
    'ADITE DIRAN',
    'AKATUSIIMA RAVEN',
    'ANZOA JOVANNAH',
    'ATURINDA KELTON',
    'BALUKU ELEUTHERIUS BROGAN',
    'BUGINGO JORAM',
    'BYEGANJE JOSEMARY ROVINSAH',
    'ITUNGO ISOBEL AYETA',
    'KAAZA JEMIMAH',
    'KABISWA ISAAC',
    'KALUNGI DAVID',
    'KASULE GORDON',
    'KATUMBA MARTHA',
    'KIRABO MADRINE PRINCESS',
    'KIWENDO CALVIN',
    'KYOMUGISHA ETHEL HANNAH',
    'LUYIGA RAHIM',
    'MAYITTO CHRISTIAN',
    'MIREMBE GIFT REBECCA',
    'MIRIMU ELIJAH',
    'MUGARURA PAXTON',
    'MUGENYI RYAN',
    'MUKIIBI JOSEPH',
    'MUKISA JEFFRON',
    'MUKISA SHAMMAH',
    'MURUNGI AARON',
    'MUSIIMENTA HANNAH AMITO',
    'MUTEBI JORDAN DIEGO',
    'MUWANGUZI ETHAN',
    'NABACHWA SHIVAN',
    'NABUKENYA TYRA',
    'NAJJINGO RHONITAH LUCY',
    'NAKAWUKI RIANAH',
    'NAKAYENGA MARY KATEREGGA',
    'NAKIBUULE SHEENAH',
    'NAKIJJE PRISCA RESTY',
    'NAKIMERA MARIA',
    'NAKIMULI KATRINAH PEACE',
    'NAMAGANDA LUISA JOY',
    'NAMMANDA HAIFA',
    'NANGENDO GABRIELLA',
    'NANSAMBA ESTHER',
    'NASSAAZI JACINTA KIZZA',
    'NATYABA EVELYN TENDO',
    'NAYIGA SHUDAT ZAHARA',
    'NYANZI RAYAN',
    'OSINDE AHMED',
    'SSAAZI RAPHEAL',
    'SSENDAGI SOLOMON',
    'SSENUNGI TITUS',
    'SSERUGO ASHLEY',
    'YEBETE MARY SADAD ELIAS'
  ],
  'Skyhigh': [
  'ABAHO FARRELL',
    'AINEMBABAZI ELIANAH',
    'AMAANI JEHEL KAISER',
    'ARIHO CALVIN',
    'ATUHAIRE COMFORT',
    'ATUHAIRE PROMISE',
    'ATWIINE RUTH',
    'AYEBALE ABORIGINE',
    'BUGANZA PATIENCE',
    'BUKENYA HENRY SHADRACK',
    'ELIANA TREASURE MUKISA',
    'KABUYAYA TATIANA',
    'KAKOOZA JUMA KAGGWA',
    'KAYONDO MUSA HASHIM',
    'KIDHUUDO PATRICIA GLADYS',
    'KIMBUGWE TIMOTHY',
    'KISAWUZI PROSPER JONATHAN',
    'KIWANA GENEROUS SHAKRAN',
    'KIYAGA TERRY ELIJAH',
    'KIZITO ISAIAH',
    'KYAZZE MARIA',
    'LUBOWA SHANITAH',
    'LUBUULWA MELLISA',
    'LUZZE MARK IBRAHIM',
    'MAGOMA BENSON',
    'MURUNGI BETTINAH',
    'MURUNGI SHAREEF RAUSHAN',
    'MUTANDA LEON ARTHUR',
    'MUWANGUZI JEREMIAH ANKUNDA',
    'NAJJINGO TEOPISTA KALUNGI',
    'NAKANDI ROCINTA',
    'NAKINTU RAMLAH',
    'NAKYANZI BENINA',
    'NAMATA DIVINE HANNAH',
    'NAMITALA TONNIA',
    'NAMUTEBI LETICIA',
    'NAMYALO CLARA KETRA',
    'NANKYA NUSRAH',
    'NANOZI KEISHA',
    'NANTUME JAZMINE',
    'NDAGIRE SALMAH ALYSON',
    'NSUBUGA ERON',
    'NSUBUGA MATILDA YULLIANA',
    'OMAR ROSHEEN NSEGIMAANA',
    'PARA PATRINA',
    'RUGUMAYO JOSEPH REMIGIUS',
    'SANGA FAITH LISA',
    'SSEKATAWA CLANCY CALVIN',
    'SSENYONJO SEAN ADRIAN',
    'TALIDDA SARAH',
    'WALUGEMBE JONATHAN',
    'WAMALA CHESTNUT',
    'YIGA INNOCENT'
  ]
},
'Primary Six': {
  'Victors': [
    'ABALINABYO NATASHA',
    'AGABA REAGAN',
    'AHIMBISIBWE MARKSON',
    'AHURIRA CALEB',
    'ALUMAI ENOCK',
    'APOLOT HELLEN',
    'AUDO TRACY',
    'AYERANGO GLORIA',
    'BAGUMA JOSHUA',
    'BESIGYE KEVIN',
    'BYARUHANGA HASSAN',
    'KAKEETO K.B BENJAMIN',
    'KAKOOZA SHURAIM',
    'KALYANGO JONATHAN',
    'KATO ENOCK',
    'KAWADWA COLLINS',
    'KEMIGISHA PRINCESS',
    'KUTOSI FAITH HANNAH',
    'LUKYAMUZI IVAN',
    'LUTAAYA JONATHAN',
    'MAGUMBA SHAKUR',
    'MUBUYA RYAN',
    'MUHANGUZI LINCOLN',
    'MUHINDO PATRICK PEDIAH',
    'MUKAMA CALVIN',
    'MULINDWA TRAVIS',
    'MULUMBA ROBINSON',
    'MUTEESA JOHNBAPTIST',
    'MUTIIBWA MELLISA',
    'NABWIRE MERCILINA MARIA',
    'NAKAWEESA KELVIN NICOLE',
    'NAKAYENGA FLAVIA',
    'NAKAYONGO BEST PATRICIA',
    'NAKIMBUGWE ELITHERIA',
    'NAKKU SAMANTHA',
    'NAMUDDE VANESSA',
    'NANTEZA MAJORINE',
    'NANZIRA MARY IVY',
    'NASSUUNA KATRINAH HARIATAH',
    'NATOORO SHARITAH',
    'RUBANGAKENE GABRIEL',
    'SSEMATIMBA ERNEST',
    'SSEMPA TERRY RYAN',
    'SSENYONGA JOHN BOSCO',
    'SSERUNJOGI ALVIN',
    'SSERUNJOJI ABIGAIL',
    'TAMALE MARLON',
    'WASSWA JOHN ELIJAH',
    'ZZIWA ANDREW GERALD'
  ],
  'Vibrant': [
  'ASIIMWE DIVINE MERCY',
    'AYEBAZIBWE EDINAS',
    'BATARINGAYA COLLINS',
    'HAYRAT DAUDA',
    'KABAGAMBE GREED',
    'KARUNGI MELISSA OPRAH',
    'KASUMBA ANGEL MARIAM',
    'KATAMBALA ROMAN TUSUBIRA',
    'KIRABIRA ALVIN',
    'KIRUMIRA KEREN',
    'KITAYIMBWA STANISLAUS PROSPER',
    'KITENGEJJA PRISCILLA',
    'KIYIMBA MARIAM',
    'KIZITO ALICIA',
    'KUKIRIZA JOSHUA',
    'KYAGABA JEREMIAH',
    'KYAGABA TAYLOR',
    'LUTAISIRYE RICHARD',
    'LUTEMBE RIAZ',
    'MUTEBI IMRAN MUBIRU',
    'MASIKA SEANICE',
    'MBAZIIRA TIHAN',
    'MIREMBE ESTHER',
    'MUKWAYA MICHELLE MELVINAH EDITH',
    'MUSASIZI PHILLIP DAVIS',
    'MUWANGUZI SUHAIR',
    'NAAMARA VICTORIA',
    'NABATEREGGA JOSELYN',
    'NAGGAYI NATAVIA',
    'NAJJEMBA ANNABELL LUCY',
    'NAKABUYE ESTHER MARITEZ',
    'NAKATO MARY',
    'NAMATOVU JOSELYN',
    'NAMPIJJA JANE',
    'NAMUDDU PAULINE',
    'NANTUME PETRINAH PATIENCE',
    'NANYOMO JAZIRAH KIGOYE',
    'NSIMBI BENJAMIN',
    'NTULUME JOHN JASON',
    'RUTUNGA DARCHILLE',
    'SEKU FAVOUR LINCOLN',
    'SSEMAKULA JOEL',
    'SSEMWOGERERE IMRAN',
    'TALEMWA SHALOM LEE',
    'WASSWA JOSEPH',
    'ZIMBE JOSIAH'
   
  ],
  'Radiant': [
    'AGAWO HARMONY ASHEL',
    'AHIMBISIBWE PRINCE DENIS',
    'AINOMUGISHA JOY',
    'AMUGE TEMPLE',
    'ANKUNDA CEDRIC MURAMIRA',
    'ATUHAIRWE ALVIN',
    'ATURINDA KAREN',
    'BYARUHANGA HUSSEIN',
    'JENGO MUSTAFA',
    'KAFEERO FELIX',
    'KASOZI VERNICE CHRISTABELLE',
    'KATUSIIME SHIVAN',
    'KIRISA JAYSON JOEL',
    'KISIRA JORAM',
    'LUTAAYA JOHN WILSON',
    'MANENO MARIANA',
    'MUBIRU RAYAN KIZITO',
    'MUGAGGA JESSICAH',
    'MUHUMUZA NEWMAN',
    'NAKABALIRA MARY',
    'NAKATO THERESA SEMPA',
    'NAKAWOOYA ERINE',
    'NAKAYONDE MARIA',
    'NAKIBUULE AMINAH',
    'NAKIMULI IVY MARIA',
    'NAKINTU DANIELLA',
    'NAKIYINGI JOAN',
    'NAKYAMBADDE HENRIATA',
    'NAKYANZI COTILDA KIARA',
    'NALUBEGA SHAMIRAH',
    'NAMATOVU RACHEAL',
    'NAMUGENYI MELLISA',
    'NANTABA PATRICIA',
    'NSAZITWARI TREASURE MARY',
    'NTONGO GLORIA',
    'NUWAMANYA WILSON',
    'NUWASIIMA ANNABEL',
    'OKIA JORDAN DARENS',
    'OKOTEL BARUCH',
    'SSALI RAHIM',
    'SSERUNJOJI JOHN MARK',
    'TALEMWA GODROCK VIANNEY',
    'WASSWA JEREMIAH SEMPA',
    'WERE EDWARD KELLY',
    'WESONGA ALBERT'
  ]
},  
'Primary Seven': {
  'Winners': [
  'AGASHA CHOICE LABONITA',
  'ALLENI PATIENCE',
  'BAGANIGIRA BENSON',
  'BAYIGA DANIELLA',
  'BESIGYE IVAN',
  'BIRIBAWA JOANITAH',
  'BIRUNGI ANGEL LUYIMA',
  'BUKIRWA JOVIN MARIAM',
  'BUSINGE BIVA',
  'DUKU RUDOLF',
  'KAKONGE ALTON',
  'KIGGUNDU PRINCE PAUL',
  'KIRIBA HAM',
  'KISENYI OSCAR',
  'KWAGALA PATIENCE',
  'KYOMUHENDO JULIANAH PRECIOUS',
  'LUGOBE FRANCIS LUTAAYA',
  'LUKWAGO EVANS',
  'MAGALA ETHAN WILLIAMS',
  'MIIRO ACRAM',
  'MUKISA CALEB ALBERT',
  'MUSIIME ELISSA',
  'MUSINGUZI KRIVIE',
  'MUTYABA ABDULLATIF',
  'MWANJE LOUIS',
  'NABBANJA JULIAN',
  'NAKIMULI TRINITY KISITU',
  'NAKIRAGGA RITAH',
  'NAMALE ROLITAH MARTHA',
  'NAMATOVU KAUTHARAH',
  'NAMBOWA MILLY',
  'NAMBUYA CHARITY',
  'NANYANGE JARVICE',
  'NASSALI JUSTINE',
  'NASSONKO NINA ROSE',
  'NTEGE RASHID',
  'NYONYOZI SHIFRAH MIREMBE',
  'SSEBAGALA RAHIM',
  'SSENTONGO WILLIAM',
  'SSERUBIRI DARVIN LUTEETE',
  'TUMUSIIME JEREMIAH',
  'VICTOR CHRISTIAN KASOZI'
  ],
  'Achievers': [
  'ABIGAIL TAFFI',
  'AGWANG NIESHA',
  'ALEX JOSHUA WALUSIMBI',
  'ATWIINE KEITH',
  'BAITAWO JONATHAN DAWSON',
  'BBAALE HAYAN',
  'BWENGYE MARK',
  'BWIRE PROSPER',
  'DDAMULIRA ELVIS',
  'JASMINE NOELLA ABER',
  'KABEJJA NAGADYA CATHERINE',
  'KAKANDE MICHEAL CHAVIS',
  'KAKOOZA GERALD BRITON',
  'KALUNDU MIGUEL',
  'KANSIIME MARIA IMMACULATE',
  'KARUNGI NADIA',
  'KASOMA MEDDIE',
  'KAYONGO FAZIL',
  'KENGAJU EVE HANNAH',
  'KIBIRANGO GIFT ENOCK',
  'KIGGUNDU RAYAN',
  'KIYAGA RAYAN',
  'KIZZA RAUTHA NABUKENYA',
  'KUZZA SCOTT JOHN',
  'KYOMUGISHA PEARL ANGEL',
  'LUKWAGO KEITH KYMANI',
  'LULE BRIGHT BLESSING',
  'LUTAAYA OLIVIA FLORENCE',
  'MASIKA PATRICIA',
  'MBABAZI FLAVIA',
  'MORIKU BRIDGET',
  'MUBINZI SAMUEL',
  'MUGANGA JEROME',
  'MUGERWA NATHAN KENNETH',
  'MULUNGI DENISE',
  'NABUKEERA PRISCILLA',
  'NAGIRINYA SHERINA JOY',
  'NAKAMATTE ELIZABETH',
  'NAKIGUDDE NOELINE',
  'NAKIMERA ANTHOUSA',
  'NAKIMERA MARIA ELIZABETH',
  'NAKIYIMBA SANAH',
  'NALUYIMA JOSELYN',
  'NAMAKULA MARY DELISHA',
  'NAMATA SHARON SEKATE',
  'NAMUBIRU EVELYN CLARISA',
  'NAMUDDU ERINAH MAURISIA',
  'NAMULEMA TAKIA',
  'NAMULINDWA JAMIRAH',
  'NANGENDO RABIIBAH',
  'NANYONJO MACKLINE',
  'NSEREKO ABDUL RAHIM',
  'NSUBUGA RICHARD',
  'SSAAZI WHITNEY',
  'SSUUBI KETRA NAMUGENYI',
  'SSUUNA RAYAN JJUNJU',
  'TUKUNDANE EION',
  'TUMWEBAZE AUSTIN',
  'UWASE BRENDA',
  'WALUSIMBI KEDRINE'
  ]
}
        };

// Function to sort students alphabetically
function sortStudents(students) {
    return students.sort((a, b) => a.localeCompare(b));
}

// Sort students in each stream of each class
for (let className in studentData) {
    for (let streamName in studentData[className]) {
        studentData[className][streamName] = sortStudents(studentData[className][streamName]);
    }
}

async function exportToJSON() {
    if (!validateTable()) {
        showNotification("Please correct the errors in the table before exporting.", "error");
        return;
    }

    const selectedClass = classSelect.value;
    const selectedStream = streamSelect.value;
    const rows = document.querySelectorAll('#gradeTable tr');
    let jsonData = {
        class: selectedClass,
        stream: selectedStream,
        students: [],
        analysis: {
            division: {},
            aggregate: {},
            subject: {}
        }
    };

    // Export student data
    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const columns = row.querySelectorAll('td');
        const studentData = {
            name: columns[0].textContent,
            math: {
                marks: columns[1].querySelector('input').value,
                grade: columns[2].textContent.split(' ')[0],
                aggregates: parseInt(columns[2].textContent.split('(')[1])
            },
            english: {
                marks: columns[3].querySelector('input').value,
                grade: columns[4].textContent.split(' ')[0],
                aggregates: parseInt(columns[4].textContent.split('(')[1])
            },
            sst: {
                marks: columns[5].querySelector('input').value,
                grade: columns[6].textContent.split(' ')[0],
                aggregates: parseInt(columns[6].textContent.split('(')[1])
            },
            science: {
                marks: columns[7].querySelector('input').value,
                grade: columns[8].textContent.split(' ')[0],
                aggregates: parseInt(columns[8].textContent.split('(')[1])
            },
            totalAggregates: columns[9].textContent,
            division: columns[10].textContent
        };
        jsonData.students.push(studentData);
    }

    // Export Division Analysis
    const divisionRows = document.querySelectorAll('#divisionAnalysisTable tbody tr');
    divisionRows.forEach(row => {
        const division = row.cells[0].textContent;
        const count = parseInt(row.cells[1].textContent);
        jsonData.analysis.division[division] = count;
    });

    // Export Aggregate Analysis
    const aggregateRows = document.querySelectorAll('#aggregateAnalysisTable tbody tr');
    aggregateRows.forEach(row => {
        const aggregate = row.cells[0].textContent;
        const count = parseInt(row.cells[1].textContent);
        jsonData.analysis.aggregate[aggregate] = count;
    });

    // Export Subject Analysis
    const subjectRows = document.querySelectorAll('#subjectAnalysisTable tbody tr');
    subjectRows.forEach(row => {
        const subject = row.cells[0].textContent;
        jsonData.analysis.subject[subject] = {
            D1: parseInt(row.cells[1].textContent),
            D2: parseInt(row.cells[2].textContent),
            C3: parseInt(row.cells[3].textContent),
            C4: parseInt(row.cells[4].textContent),
            C5: parseInt(row.cells[5].textContent),
            C6: parseInt(row.cells[6].textContent),
            P7: parseInt(row.cells[7].textContent),
            P8: parseInt(row.cells[8].textContent),
            F9: parseInt(row.cells[9].textContent),
            X: parseInt(row.cells[10].textContent),
            firstGrades: parseInt(row.cells[11].textContent),
            position: parseInt(row.cells[12].textContent)
        };
    });

    // Convert to JSON string
    const jsonString = JSON.stringify(jsonData, null, 2);
    const fileName = `${selectedClass}_${selectedStream}_Results.json`;

    if ('showSaveFilePicker' in window) {
        try {
            const fileHandle = await window.showSaveFilePicker({
                suggestedName: fileName,
                types: [{
                    description: 'JSON File',
                    accept: {'application/json': ['.json']},
                }],
            });
            const writable = await fileHandle.createWritable();
            await writable.write(jsonString);
            await writable.close();
            console.log('File saved successfully using modern API');
            showNotification("Data exported successfully!", "success");
        } catch (err) {
            if (err.name === 'AbortError') {
                console.log('User cancelled the save operation');
                showNotification("Export cancelled", "info");
            } else {
                console.warn('Error using modern save method:', err);
                showNotification("Error exporting data. Please try again.", "error");
            }
        }
    } else {
        const shouldSave = confirm("Do you want to save the file?");
        if (shouldSave) {
            fallbackSaveMethod(jsonString, fileName);
            showNotification("Data exported successfully (using fallback method).", "success");
        } else {
            showNotification("Export cancelled", "info");
        }
    }
}

function fallbackSaveMethod(content, fileName) {
    const blob = new Blob([content], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = fileName;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    setTimeout(() => {
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }, 100);
}


const classSelect = document.getElementById('classSelect');
const streamSelect = document.getElementById('streamSelect');
const goToGradingBtn = document.getElementById('goToGradingBtn');

// Function to populate the class select
function populateClassSelect() {
    classSelect.innerHTML = '<option value="" disabled selected>Select Class</option>';
    for (const className in studentData) {
        const option = document.createElement('option');
        option.value = className;
        option.textContent = className;
        classSelect.appendChild(option);
    }
}

// Function to populate the stream select based on the selected class
function populateStreamSelect(className) {
    streamSelect.innerHTML = '<option value="" disabled selected>Select Stream</option>';
    if (studentData[className]) {
        for (const streamName in studentData[className]) {
            const option = document.createElement('option');
            option.value = streamName;
            option.textContent = streamName;
            streamSelect.appendChild(option);
        }
        streamSelect.style.display = 'block';
    } else {
        streamSelect.style.display = 'none';
        goToGradingBtn.style.display = 'none';
    }
}

// Populate the class select when the page loads
populateClassSelect();

// Event listener for class select
classSelect.addEventListener('change', function() {
    if (this.value) {
        populateStreamSelect(this.value);
        streamSelect.style.display = 'block';
    } else {
        streamSelect.style.display = 'none';
        goToGradingBtn.style.display = 'none';
    }
});

// Event listener for stream select
streamSelect.addEventListener('change', function() {
    goToGradingBtn.style.display = this.value ? 'block' : 'none';
});

goToGradingBtn.addEventListener('click', function() {
    const selectedClass = classSelect.value;
    const selectedStream = streamSelect.value;
    classStreamTitle.textContent = `${selectedClass} - ${selectedStream}`;
    createTableRows(studentData[selectedClass][selectedStream]);
    welcomePage.style.display = 'none';
    gradingPage.style.display = 'block';
    showNotification(`Grading page loaded for ${selectedClass} - ${selectedStream}`, "info");
});

// Function to calculate grade and aggregates based on marks
// Function to calculate grade and aggregates based on marks
function calculateGrade(marks, isPrimarySeven) {
    if (marks === "-") return { grade: "X", aggregates: null };
    if (marks === "") return { grade: "", aggregates: 0 };
    marks = parseInt(marks);
    if (isNaN(marks) || marks < 0 || marks > 100) return { grade: "", aggregates: 0 };
    
    if (isPrimarySeven) {
        // Special grading for Primary Seven
        if (marks >= 95) return { grade: "D1", aggregates: 1 };
        if (marks >= 85) return { grade: "D2", aggregates: 2 };
        if (marks >= 70) return { grade: "C3", aggregates: 3 };
        if (marks >= 65) return { grade: "C4", aggregates: 4 };
        if (marks >= 60) return { grade: "C5", aggregates: 5 };
        if (marks >= 55) return { grade: "C6", aggregates: 6 };
        if (marks >= 50) return { grade: "P7", aggregates: 7 };
        if (marks >= 40) return { grade: "P8", aggregates: 8 };
        return { grade: "F9", aggregates: 9 };
    } else {
        // Original grading for other classes
        if (marks >= 90) return { grade: "D1", aggregates: 1 };
        if (marks >= 80) return { grade: "D2", aggregates: 2 };
        if (marks >= 70) return { grade: "C3", aggregates: 3 };
        if (marks >= 65) return { grade: "C4", aggregates: 4 };
        if (marks >= 60) return { grade: "C5", aggregates: 5 };
        if (marks >= 55) return { grade: "C6", aggregates: 6 };
        if (marks >= 50) return { grade: "P7", aggregates: 7 };
        if (marks >= 40) return { grade: "P8", aggregates: 8 };
        return { grade: "F9", aggregates: 9 };
    }
}

// Function to calculate division based on total aggregates
function calculateOverallResult(totalAggregates, hasMissedExam, hasF9) {
    if (hasMissedExam) {
        return { totalAggregates: "X", division: 'X' };
    }
    let division = calculateDivision(totalAggregates);
    if (division === "1" && hasF9) {
        division = "2";
    }
    return { totalAggregates, division };
}

function calculateDivision(totalAggregates) {
    if (totalAggregates >= 4 && totalAggregates <= 12) return "1";
    if (totalAggregates >= 13 && totalAggregates <= 24) return "2";
    if (totalAggregates >= 25 && totalAggregates <= 28) return "3";
    if (totalAggregates >= 29 && totalAggregates <= 32) return "4";
    if (totalAggregates >= 33 && totalAggregates <= 36) return "U";
    return "U"; // This covers cases where totalAggregates > 36
}

function calculateTotalAggregates(student) {
    const subjects = ['math', 'english', 'sst', 'science'];
    const totalAggregates = subjects.reduce((total, subject) => {
        return total + (student[subject].aggregates || 0);
    }, 0);
    return totalAggregates > 0 ? totalAggregates : '';
}

function updateResults(input) {
    const row = input.closest('tr');
    const aggregateCell = input.parentElement.nextElementSibling;
    const marks = input.value.trim();
    
    const selectedClass = classSelect.value;
    const isPrimarySeven = selectedClass === 'Primary Seven';
    
    if (marks === "") {
        aggregateCell.textContent = "";
    } else {
        const { grade, aggregates } = calculateGrade(marks, isPrimarySeven);
        aggregateCell.textContent = grade;
    }

    const mainSubjectInputs = row.querySelectorAll('.subject-mark.main-subject');
    let totalAggregates = 0;
    let hasMissedExam = false;
    let hasF9 = false;
    let allMainFieldsFilled = true;
    let validSubjectCount = 0;

    mainSubjectInputs.forEach((input) => {
        const value = input.value.trim();
        if (value === "") {
            allMainFieldsFilled = false;
        } else {
            const { grade, aggregates } = calculateGrade(value, isPrimarySeven);
            if (grade === "X") {
                hasMissedExam = true;
            } else if (grade === "F9") {
                hasF9 = true;
                totalAggregates += aggregates;
                validSubjectCount++;
            } else if (aggregates !== null) {
                totalAggregates += aggregates;
                validSubjectCount++;
            }
        }
    });

    // Update minor subjects aggregates
    const minorSubjectInputs = row.querySelectorAll('.subject-mark.minor-subject');
    minorSubjectInputs.forEach((input) => {
        const minorAggregateCell = input.parentElement.nextElementSibling;
        const minorMarks = input.value.trim();
        if (minorMarks === "") {
            minorAggregateCell.textContent = "";
        } else {
            const { grade } = calculateGrade(minorMarks, isPrimarySeven);
            minorAggregateCell.textContent = grade;
        }
    });

    const totalAggregatesCell = row.querySelector('.total-aggregates');
    const divisionCell = row.querySelector('.division');

    if (allMainFieldsFilled) {
        const { totalAggregates: finalTotal, division } = calculateOverallResult(totalAggregates, hasMissedExam, hasF9);
        totalAggregatesCell.textContent = finalTotal;
        divisionCell.textContent = division;
    } else {
        totalAggregatesCell.textContent = '';
        divisionCell.textContent = '';
    }
}

function validateTable() {
    const inputs = document.querySelectorAll('.subject-mark');
    let isValid = true;
    
    inputs.forEach(input => {
        const value = input.value.trim();
        if (value === "-") {
            input.setCustomValidity(""); // Clear any previous validation message
        } else {
            const numValue = parseFloat(value);
            if (value === "" || isNaN(numValue) || numValue < 0 || numValue > 100) {
                isValid = false;
                input.setCustomValidity("Please enter a number between 0 and 100, or '-' for no score.");
            } else {
                input.setCustomValidity(""); // Clear any previous validation message
            }
        }
        input.reportValidity();
    });
    
    return isValid;
}


function createTableRows(studentList) {
    const tableBody = document.getElementById('gradeTableBody');
    const tableHeader = document.getElementById('gradeTableHeader');
    tableBody.innerHTML = '';
    
    const selectedClass = classSelect.value;
    const isLowerPrimary = ['Primary One', 'Primary Two', 'Primary Three'].includes(selectedClass);
    const isPrimarySeven = selectedClass === 'Primary Seven';
    
    // Update table header
    if (isLowerPrimary) {
        tableHeader.innerHTML = `
            <tr>
                <th>Name</th>
                <th>ENG</th>
                <th>Agg</th>
                <th>MTC</th>
                <th>Agg</th>
                <th>SCIE</th>
                <th>Agg</th>
                <th>SST</th>
                <th>Agg</th>
                <th class="minor-subject">ICT</th>
                <th class="minor-subject">Agg</th>
                <th class="minor-subject">KISW</th>
                <th class="minor-subject">Agg</th>
                <th class="minor-subject">Writing</th>
                <th class="minor-subject">Agg</th>
                <th>TAG</th>
                <th>Div</th>
            </tr>
        `;
    } else if (isPrimarySeven) {
        tableHeader.innerHTML = `
            <tr>
                <th>Name</th>
                <th>ENG</th>
                <th>Agg</th>
                <th>MTC</th>
                <th>Agg</th>
                <th>SCIE</th>
                <th>Agg</th>
                <th>SST</th>
                <th>Agg</th>
                <th>TAG</th>
                <th>Div</th>
            </tr>
        `;
    } else {

        tableHeader.innerHTML = `
            <tr>
                <th>Name</th>
                <th>ENG</th>
                <th>Agg</th>
                <th>MTC</th>
                <th>Agg</th>
                <th>SCIE</th>
                <th>Agg</th>
                <th>SST</th>
                <th>Agg</th>
                <th class="minor-subject">ICT</th>
                <th class="minor-subject">Agg</th>
                <th class="minor-subject">KISW</th>
                <th class="minor-subject">Agg</th>
                <th>TAG</th>
                <th>Div</th>
            </tr>
        `;
    }
    
    studentList.forEach((student, rowIndex) => {
    const row = document.createElement('tr');
    let rowHTML = `
        <td class="name-cell">
            ${rowIndex + 1}. <span class="student-name">${student}</span>
            <div class="name-options">
                <button class="edit-name">Edit</button>
                <button class="delete-name">Delete</button>
            </div>
        </td>
        <td><input type="text" class="subject-mark main-subject" required pattern="^\\d+$|^-$" maxlength="3"></td>
        <td class="subject-aggregate"></td>
        <td><input type="text" class="subject-mark main-subject" required pattern="^\\d+$|^-$" maxlength="3"></td>
        <td class="subject-aggregate"></td>
        <td><input type="text" class="subject-mark main-subject" required pattern="^\\d+$|^-$" maxlength="3"></td>
        <td class="subject-aggregate"></td>
        <td><input type="text" class="subject-mark main-subject" required pattern="^\\d+$|^-$" maxlength="3"></td>
        <td class="subject-aggregate"></td>
    `;
    
    if (isLowerPrimary) {
        rowHTML += `
            <td><input type="text" class="subject-mark minor-subject" pattern="^\\d+$|^-$" maxlength="3"></td>
            <td class="subject-aggregate minor-subject"></td>
            <td><input type="text" class="subject-mark minor-subject" pattern="^\\d+$|^-$" maxlength="3"></td>
            <td class="subject-aggregate minor-subject"></td>
            <td><input type="text" class="subject-mark minor-subject" pattern="^\\d+$|^-$" maxlength="3"></td>
            <td class="subject-aggregate minor-subject"></td>
        `;
    } else if (isPrimarySeven) {
        // No minor subjects for Primary Seven
    } else {
        rowHTML += `
            <td><input type="text" class="subject-mark minor-subject" pattern="^\\d+$|^-$" maxlength="3"></td>
            <td class="subject-aggregate minor-subject"></td>
            <td><input type="text" class="subject-mark minor-subject" pattern="^\\d+$|^-$" maxlength="3"></td>
            <td class="subject-aggregate minor-subject"></td>
        `;
    }
    
    rowHTML += `
        <td class="total-aggregates"></td>
        <td class="division"></td>
    `;
    
    row.innerHTML = rowHTML;
    tableBody.appendChild(row);

        // Add event listeners for name CRUD operations
        const nameCell = row.querySelector('.name-cell');
        const nameSpan = nameCell.querySelector('.student-name');
        const nameOptions = nameCell.querySelector('.name-options');

        nameCell.addEventListener('click', (e) => {
            if (e.target === nameCell || e.target === nameSpan) {
                nameOptions.style.display = 'inline-block';
            }
        });

        document.addEventListener('click', (e) => {
            if (!nameCell.contains(e.target)) {
                nameOptions.style.display = 'none';
            }
        });

        const editButton = nameOptions.querySelector('.edit-name');
        const deleteButton = nameOptions.querySelector('.delete-name');

        editButton.addEventListener('click', () => {
            showModel('edit', student, (newName) => {
                nameSpan.textContent = newName;
                updateAnalysisTables();
            });
        });

        deleteButton.addEventListener('click', () => {
            showModel('delete', student, () => {
                row.remove();
                updateRowNumbers();
                updateAnalysisTables();
            });
        });
    });
 
  
    function showModel(action, studentName, callback) {
    const model = document.createElement('div');
    model.className = 'model';
    model.innerHTML = `
        <div class="model-content">
            <h2>${action === 'edit' ? 'Edit Student Name' : 'Delete Student'}</h2>
            ${action === 'edit' 
                ? `<input type="text" id="editNameInput" value="${studentName}" placeholder="Enter student name">`
                : `<p>Are you sure you want to delete ${studentName}?</p>`
            }
            <div class="model-buttons">
                <button id="confirmButton">${action === 'edit' ? 'Save' : 'Delete'}</button>
                <button id="cancelButton">Cancel</button>
            </div>
        </div>
    `;

    document.body.appendChild(model);

    const confirmButton = model.querySelector('#confirmButton');
    const cancelButton = model.querySelector('#cancelButton');

confirmButton.addEventListener('click', () => {
    if (action === 'edit') {
        const newName = model.querySelector('#editNameInput').value;
        callback(newName);
        showFlashMessage(`${studentName}'s name updated to ${newName} successfully!`);
    } else {
        callback();
        showFlashMessage(`${studentName} deleted successfully!`);
    }
    closeModel(model);
});

    cancelButton.addEventListener('click', () => {
        closeModel(model);
        showFlashMessage('Operation cancelled');
    });
}

function closeModel(model) {
    document.body.removeChild(model);
}

function showFlashMessage(message) {
    const flashMessage = document.createElement('div');
    flashMessage.className = 'flash-message';
    flashMessage.textContent = message;

    document.body.appendChild(flashMessage);

    setTimeout(() => {
        flashMessage.classList.add('fade-out');
        setTimeout(() => {
            document.body.removeChild(flashMessage);
        }, 500);
    }, 3000);
}

function updateRowNumbers() {
    const rows = document.querySelectorAll('#gradeTableBody tr');
    rows.forEach((row, index) => {
        const nameCell = row.querySelector('.name-cell');
        const numberSpan = nameCell.firstChild;
        numberSpan.textContent = `${index + 1}. `;
    });
}

function addNewStudent() {
    const tableBody = document.getElementById('gradeTableBody');
    const newRowIndex = tableBody.children.length;
    const newRow = document.createElement('tr');
    
    let rowHTML = `
        <td class="name-cell">
            ${newRowIndex + 1}. <span class="student-name" contenteditable="true">New Student</span>
            <div class="name-options" style="display: none;">
                <button class="edit-name">Edit</button>
                <button class="delete-name">Delete</button>
            </div>
        </td>
    `;

    // Add the rest of the cells (subject marks, aggregates, etc.)
    // This part will be similar to the row creation in createTableRows function

    newRow.innerHTML = rowHTML;
    tableBody.appendChild(newRow);

    // Add event listeners for the new row (similar to createTableRows function)
    // ...

    updateAnalysisTables();
}

    const allInputs = tableBody.querySelectorAll('.subject-mark');
    allInputs.forEach((input, index) => {
        input.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9-]/g, '');
            validateAndUpdateResults(this);
            
            // Check if the input is complete and valid before moving to the next cell
            const numValue = parseInt(this.value);
            if ((numValue > 10 && numValue < 100) || this.value === '-' || this.value === '100') {
                if (index < allInputs.length - 1) {
                    allInputs[index + 1].focus();
                }
            }
        });
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === 'ArrowRight') {
                e.preventDefault();
                if (index < allInputs.length - 1) {
                    allInputs[index + 1].focus();
                }
            } else if (e.key === 'ArrowLeft') {
                e.preventDefault();
                if (index > 0) {
                    allInputs[index - 1].focus();
                }
            }
        });
        input.addEventListener('blur', () => validateAndUpdateResults(input));
    });

    // Update the Subject Analysis table header for Primary Seven
    const subjectAnalysisTable = document.getElementById('subjectAnalysisTable');
    if (subjectAnalysisTable) {
        const subjectHeader = subjectAnalysisTable.querySelector('thead');
        if (isPrimarySeven) {
            subjectHeader.innerHTML = `
                <tr>
                    <th>Subject</th>
                    <th>D1</th>
                    <th>D2</th>
                    <th>C3</th>
                    <th>C4</th>
                    <th>C5</th>
                    <th>C6</th>
                    <th>P7</th>
                    <th>P8</th>
                    <th>F9</th>
                    <th>X</th>
                    <th>First Grades</th>
                    <th>%</th>
                    <th>POINTS</th>
                    <th>POS</th>
                </tr>
            `;
        } else {
            subjectHeader.innerHTML = `
                <tr>
                    <th>Subject</th>
                    <th>D1</th>
                    <th>D2</th>
                    <th>C3</th>
                    <th>C4</th>
                    <th>C5</th>
                    <th>C6</th>
                    <th>P7</th>
                    <th>P8</th>
                    <th>F9</th>
                    <th>X</th>
                    <th>First Grades</th>
                    <th>%</th>
                    <th>POS</th>
                </tr>
            `;
        }
    }
}

function handleInputChange(input) {
    const value = input.value;
    if (value === '-' || value === '100' || (value.length === 2 && parseInt(value) >= 11 && parseInt(value) <= 99)) {
        moveToNextInput(input);
    }
}

function moveToNextInput(currentInput) {
    // Add leading zero if necessary
    if (currentInput.value.length === 1 && parseInt(currentInput.value) >= 0 && parseInt(currentInput.value) <= 9) {
        currentInput.value = '0' + currentInput.value;
    }

    const currentCell = currentInput.parentElement;
    const currentRow = currentCell.parentElement;
    const cells = Array.from(currentRow.cells);
    const currentIndex = cells.indexOf(currentCell);
    
    // Find the next input field
    for (let i = currentIndex + 1; i < cells.length; i++) {
        const nextInput = cells[i].querySelector('input');
        if (nextInput) {
            nextInput.focus();
            nextInput.select();  // Select the text in the next input
            return;
        }
    }
    
    // If we're at the last cell of the current row, move to the first cell of the next row
    const nextRow = currentRow.nextElementSibling;
    if (nextRow) {
        const firstInput = nextRow.querySelector('input');
        if (firstInput) {
            firstInput.focus();
            firstInput.select();  // Select the text in the next input
        }
    }
}

function validateAndUpdateResults(input) {
    const value = input.value.trim();
    
    if (value === "-") {
        input.setCustomValidity("");
        input.classList.remove('invalid-input');
    } else if (value === "") {
        input.setCustomValidity("This field is required. Enter a number or '-' for no score.");
        input.classList.add('invalid-input');
    } else {
        const numValue = parseFloat(value);
        if (!/^\d+$/.test(value) || isNaN(numValue)) {
            input.setCustomValidity("Please enter a valid whole number between 0 and 100, or '-' for no score.");
            input.classList.add('invalid-input');
        } else if (numValue < 0 || numValue > 100) {
            input.setCustomValidity("Please enter a number between 0 and 100.");
            input.classList.add('invalid-input');
        } else {
            input.setCustomValidity("");
            input.classList.remove('invalid-input');
        }
    }
    
    updateResults(input);
    updateAnalysisTables(); // Add this line

}
    </script>
</body>
</html>